<!DOCTYPE html>
<html>
   <head>
       <title>Post</title>

       <meta charset="UTF-8">

       <meta name="viewport" content="initial-scale=1" />
           
       <meta name="format-detection" content="telephone=no">

       <script src="javascript/lib/jquery/jquery-1.7.1.js"></script>
       <script src="javascript/lib/handlebars/handlebars-1.0.beta6.js"></script>
       <script src="javascript/lib/underscore/underscore-1.3.1.min.js"></script>
       <script src="javascript/lib/moment/moment-1.7.2.min.js"></script>
       <script src="javascript/lib/prettify/prettify.js"></script>
       <script src="javascript/lib/prettify/lang-css.js"></script>
       <script src="javascript/lib/prettify/lang-scala.js"></script>
       <script src="javascript/lib/prettify/lang-sql.js"></script>
       <script src="javascript/md5.js"></script>

       <link rel="stylesheet" href="css/styles.css">
       <link rel="stylesheet" href="javascript/lib/prettify/twilight.css" />
   </head>
   <body>

       <div id="post">
           <div id="post-header"></div>
           <div id="post-body"></div>
       </div>

       <script>

           function isIOSBrowser() {
               return navigator.userAgent.match(/(iPhone|iPod|iPad)/i);
           }

           function initLogging() {

               if(isIOSBrowser()) {
                   // Debug
                   console = new Object();
                   console.log = function(log) {
                      executeObjcCall("ios-log://" + log);
                   };

                   console.debug = console.log;
                   console.info = console.log;
                   console.warn = console.log;
                   console.error = console.log;
               }
           }

           initLogging();

           var jsonPost;

           function onLoad(data) {
               jsonPost = data;
               applyTemplate('#post-header-template', '#post-header', {
                   post: jsonPost,
                   modified: moment(jsonPost.modified, "YYYY-MM-DD").format("DD/MM/YYYY")
               });

               applyTemplate('#post-body-template', '#post-body', {
                   post: jsonPost,
                   content: htmlDecode(jsonPost.content)
               }, [prettifyImages]);

               prettyPrint();

               prettifyGravatar("post-author-image", jsonPost.author);
           }

           function applyTemplate(templateId, targetId, data, processors) {
               var source = $(templateId).html();
               var template = Handlebars.compile(source);
               var html = template(data);

               if (processors) {
                   _(processors).each(function(processor) {
                      html = processor(html);
                   });
               }

               $(targetId).html(html);
           }

           $(document).ready(function() {
               $.getJSON('http://localhost:8000/api/wordpress/post/5625', function(json) {
                   onLoad(json);
               });
           });
       </script>

       <script id="post-header-template" type="text/x-handlebars-template">

           <div id="post-header-title">
               <h1>{{post.title}}</h1>
           </div>

           <div id="post-header-body">
               <div id="post-author-images-content">
                   <ul id="post-author-images">
                       <li data-id="{{post.id}}">
                           <img id="post-author-image" src="image/avatar/xebia-avatar.png" />
                       </li>
                   </ul>
               </div>
               <div id="post-header-body-content">
                   <h1>{{post.author.first_name}} {{post.author.last_name}}</h1>
                   <h2>Publi√© le : <em>{{modified}}</em></h2>
                   <h2>
                       Tags : <em><ul id="post-tags" style="display: inline;">
                           {{#each post.tags}}
                           <li style="display: inline;"><a href="wordpress://tag/{{this.slug}}">{{this.title}}</a></li>
                           {{/each}}
                       </ul></em>
                   </h2>
               </div>
           </div>

       </script>

       <script id="post-body-template" type="text/x-handlebars-template">
           {{{content}}}
       </script>

       <script>
           function prettifyCodeFragments2(content) {
               var openRegExp = new RegExp('<pre class="brush: ([^;]+);[^>]+"[^>]+>(\r\n)?', 'g');
               var closeegExp = new RegExp('</pre>', 'g');

               var openWithGutter = '<pre class="prettyprint linenums gutter:true"><code class="lang-$1">';

               content = content.replace(openRegExp, openWithGutter).replace(closeegExp, "</code></pre>");

               return content
           }

           function prettifyCodeFragments(content) {

               var languages = {
                   'javascript': 'js',
                   'java': 'java',
                   'html': 'html',
                   'scala': 'scala',
                   'css': 'css',
                   'sql': 'sql',
                   'coffee': 'coffee',
                   'coffeescript': 'coffee',
                   'groovy': 'groovy',
                   'shell': 'sh',
                   'ruby': 'rb',
                   'phyton': 'py',
                   'dart': 'dart',
                   'jruby': 'jruby',
                   'clojure': 'cojure',
                   'c': 'c',
                   'cpp': 'cpp',
                   'cs': 'cs',
                   'objc': 'c',
                   'obj-c': 'c',
                   'erlang': 'erlang',
                   'xml': 'xml',
                   'xsl': 'xsl',
                   'actionscript': 'js',
                   'mxml': 'mxml'
               };

               _(languages).each(function (value, key) {

                   var open = '<pre class="prettyprint linenums:1 gutter:false"><code class="lang-' + value + '" style="white-space: nowrap;">';
                   var openWithGutter = '<pre class="prettyprint linenums gutter:true"><code class="lang-' + value + '" style="white-space: nowrap;">';
                   var close = '</pre></code>';

                   var openRegExp = new RegExp('\\[' + key + '\\]', 'g');
                   var closeegExp = new RegExp('\\[\\/' + key + '\\]', 'g');

                   content = content.replace(openRegExp, open).replace(closeegExp, close);

                   openRegExp = new RegExp('\\[' + key + '\\ gutter=\\"false"\\]', 'g');
                   closeegExp = new RegExp('\\[\\/' + key + '\\ gutter=\\"false\\"]', 'g');

                   content = content.replace(openRegExp, open).replace(closeegExp, close);

                   openRegExp = new RegExp('\\[' + key + '\\ gutter=\\"true"\\]', 'g');
                   closeegExp = new RegExp('\\[\\/' + key + '\\ gutter=\\"true\\"]', 'g');

                   content = content.replace(openRegExp, openWithGutter).replace(closeegExp, close);

               });

               return content;
           }

           function prettyLineReturns(html) {
               html = html.replace("<br>", "<br />").replace("<br/>", "<br />");
               html = html.replace(/(<br \/>)+/g, '<br />');
               html = html.replace(/<p>\u00a0<\/p>/g, '');

               return html;
           }

           if (typeof String.prototype.startsWith != 'function') {
             // see below for better implementation!
             String.prototype.startsWith = function (str){
               return this.indexOf(str) == 0;
             };
           }

           function prettifyImages(html) {
               var htmlAsDom = $("<div/>");
               htmlAsDom.html(html);

               console.log("*** Count: " + $("img", htmlAsDom).length);

               $("img", htmlAsDom).each(function() {
                   var rawImage = $(this)[0];
                   console.log("*** Raw Image: " + rawImage);
                   var image = $(rawImage);

                   if (isIOSBrowser()) {
                       if (image.attr("src").startsWith("http") || image.attr("src").startsWith("https")) {
                           console.log("Before: " + rawImage.outerHTML);
                           var imageGUID = GUID();
                           image.attr("data-guid", imageGUID);
                           image.attr("data-src", "cid://img/" + imageGUID + "/" + encodeURIComponent(image.attr("src")));
                           image.attr("src", "image/spacer.png");
                           console.log("After: " + rawImage.outerHTML);
                           executeObjcCall(image.attr("data-src"));
                       }
                   }

                   var floatValue = image.css("float");
//                   var windowWidth = $(window).width();
                   if (floatValue == 'left' || floatValue == 'right') {
                       image.css("max-width", "33%");
                   }
                   else {
                       image.css("max-width", "90%");
                   }
                   image.removeAttr("vspace");
                   image.css("margin", "10px");
                   image.css("border", "none");
                   image.css("padding", "0");
               });

               var html = htmlAsDom.html();

               return html;
           }

           function prettifyGravatar(id, author) {
               if(isIOSBrowser()) {
                   var image = $($('img#' + id)[0]);

                   var imageGUID = GUID();
                   image.attr("data-guid", imageGUID);
                   image.attr("data-src", "cid://gravatar/" + imageGUID + "/" + encodeURIComponent(author.email));
                   image.attr("src", "image/spacer.png");

                   executeObjcCall(image.attr("data-src"));
               }

//               if ("Xebia France" == author.nickname) {
//                   return "image/avatar/xebia-avatar.png";
//               }
//
//               var md5Hash = md5(author.nickname + '@xebia.fr', false, false);
//               var prettifyGravatar = 'http://www.gravatar.com/avatar/' + md5Hash + '?s=' + (size || 80);
//               console.log("Nickname: " + author.nickname);
//               console.log("prettifyGravatar: " + prettifyGravatar);
//               return prettifyGravatar;
           }

           function onResourceLoaded(id, src) {
               console.log("Src: " + src + ", id: " + id);
               console.log("image with path: 'img[data-guid='" + id + "']'");

               var image = $("img[data-guid='" + id + "']");

               console.log("image: " + image[0]);

               var rawImage = image[0];

               console.log("Image loaded before: " + rawImage.outerHTML);

               image.attr("src", src);
               console.log("Image loaded after: " + rawImage.outerHTML);
           }

           function executeObjcCall(statement) {
               setTimeout(function() {
                   var iframe = document.createElement("IFRAME");
                   iframe.setAttribute("src", statement);
                   document.documentElement.appendChild(iframe);
                   iframe.parentNode.removeChild(iframe);
                   iframe = null;
               }, 0);
           }

           function GUID ()
           {
               var S4 = function ()
               {
                   return Math.floor(
                           Math.random() * 0x10000 /* 65536 */
                   ).toString(16);
               };

               var guid = (
                       S4() + S4() + "-" +
                               S4() + "-" +
                               S4() + "-" +
                               S4() + "-" +
                               S4() + S4() + S4()
                       );

               return guid;
           }

           function htmlDecode(value) {
               console.log("***** value: " + value);
               var html = value;
//               var html = $('<div/>').html(value).text();
//               html = html.replace(/\r\n|\r|\n/g, '');

//               html = prettifyCodeFragmentsOld(html);
               html = prettifyCodeFragments2(html);
               html = prettyLineReturns(html);

               return html;
           }

       </script>

   </body>

</html>